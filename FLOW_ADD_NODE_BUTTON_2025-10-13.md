# Flow Studio: Add Node Button - Oct 13, 2025

## Problem

User couldn't add nodes to the Flow Studio - no right-click menu and no way to create OpenAI nodes or any other nodes. The graph was empty or loaded from file, but there was no UI to add new nodes.

## Solution

Added **"‚ûï Add Node" toolbar button** with dropdown menu containing all available node types organized by category.

## Implementation

### Toolbar Button

Location: Flow Studio toolbar (next to pan/zoom controls)

**Button Features:**

- Text: `‚ûï Add Node`
- Tooltip: `"Add a new node to the flow (or press Tab key)"`
- Popup mode: Instant (menu appears on click)
- Menu structure: Organized by category with emojis

### Menu Structure

```
‚ûï Add Node
  ‚îú‚îÄ ü§ñ LLM Providers
  ‚îÇ   ‚îú‚îÄ OpenAI (Official)
  ‚îÇ   ‚îú‚îÄ OpenRouter
  ‚îÇ   ‚îú‚îÄ Gemini (Google)
  ‚îÇ   ‚îî‚îÄ OpenAI Compatible
  ‚îÇ
  ‚îú‚îÄ üìÅ Input/Output
  ‚îÇ   ‚îú‚îÄ Context Output
  ‚îÇ   ‚îú‚îÄ File Write
  ‚îÇ   ‚îú‚îÄ Clipboard
  ‚îÇ   ‚îî‚îÄ Output Display
  ‚îÇ
  ‚îî‚îÄ üîß Utilities
      ‚îî‚îÄ Best of N
```

### Code Changes

#### 1. Toolbar Button Creation (in `_create_toolbar()`)

```python
# Add Node button with dropdown menu
add_node_btn = QtWidgets.QToolButton()
add_node_btn.setText("‚ûï Add Node")
add_node_btn.setToolTip("Add a new node to the flow (or press Tab key)")
add_node_btn.setPopupMode(QtWidgets.QToolButton.InstantPopup)

# Create add node menu
add_menu = QtWidgets.QMenu(add_node_btn)

# LLM Providers submenu
llm_menu = add_menu.addMenu("ü§ñ LLM Providers")
llm_menu.addAction("OpenAI (Official)").triggered.connect(
    lambda: self._create_node_at_center('aicp.flow', 'OpenAI Node'))
# ... more nodes

add_node_btn.setMenu(add_menu)
toolbar.addWidget(add_node_btn)
```

#### 2. Node Creation Helper (`_create_node_at_center()`)

```python
def _create_node_at_center(self, identifier: str, node_name: str):
    """Create a node at the center of the current view."""
    # Get viewport center in scene coordinates
    viewport_rect = self.viewer.viewport().rect()
    center_point = viewport_rect.center()
    scene_pos = self.viewer.mapToScene(center_point)
    pos = (scene_pos.x(), scene_pos.y())

    # Create the node
    ident_str = f"{identifier}.{node_name}"
    node = self.graph.create_node(ident_str, pos=pos)

    # Select the newly created node
    self.graph.clear_selection()
    node.set_selected(True)
```

### How It Works

1. **User clicks "‚ûï Add Node"** ‚Üí Dropdown menu appears
2. **User hovers over category** (e.g., "ü§ñ LLM Providers") ‚Üí Submenu expands
3. **User clicks node type** (e.g., "OpenAI (Official)") ‚Üí Lambda function triggers
4. **Lambda calls** `_create_node_at_center('aicp.flow', 'OpenAI Node')`
5. **Node created** at center of viewport with identifier `aicp.flow.OpenAI Node`
6. **Node selected** automatically so properties panel shows
7. **User can immediately configure** the node in properties panel

### Node Positioning

Nodes are created at the **center of the current viewport**, which means:

- If you're zoomed in on a specific area, node appears there
- If you've panned to a different part of the canvas, node appears in view
- No need to search for the newly created node - it's right in front of you

### Error Handling

If node creation fails:

- Error logged to console
- Warning dialog shown to user
- Message includes: node name, error details, suggestion to check registration

## Available Nodes

### ü§ñ LLM Providers (AI Model Nodes)

1. **OpenAI (Official)** - `aicp.flow.OpenAI Node`

   - Direct OpenAI API access
   - Models: GPT-4, GPT-3.5-turbo, etc.
   - Requires OpenAI API key

2. **OpenRouter** - `aicp.flow.OpenRouter Node`

   - OpenRouter.ai aggregator
   - Access to 100+ models
   - Requires OpenRouter API key

3. **Gemini (Google)** - `aicp.flow.Gemini Node`

   - Google Gemini API
   - Models: Gemini Pro, etc.
   - Requires Google API key

4. **OpenAI Compatible** - `aicp.flow.OpenAI Compatible Node`
   - Any OpenAI-compatible endpoint
   - Custom base URL configuration
   - For local models, proxies, etc.

### üìÅ Input/Output Nodes

1. **Context Output** - `aicp.flow.Context Output`

   - Reads from context file
   - Default: `fullcode.txt`
   - Generated by File ‚Üí Generate Code Context

2. **File Write** - `aicp.flow.File Write`

   - Writes text to file
   - Custom file path
   - Overwrites or creates file

3. **Clipboard** - `aicp.flow.Clipboard Node`

   - Copies text to system clipboard
   - Useful for quick outputs
   - No visual feedback (just copies)

4. **Output Display** - `aicp.flow.Output Display`
   - Shows output in popup dialog
   - Good for debugging flows
   - Non-blocking display

### üîß Utility Nodes

1. **Best of N** - `aicp.flow.Best of N Node`
   - Runs N parallel LLM calls
   - Picks best result
   - Requires multiple LLM inputs

## Usage Instructions

### Creating Your First Flow

1. **Click "‚ûï Add Node"** in toolbar
2. **Select "ü§ñ LLM Providers" ‚Üí "OpenAI (Official)"**
3. Node appears in center of view
4. **Configure in properties panel** (right side):
   - Set `model` to "gpt-4-turbo"
   - Set `api_key` or configure in settings
   - Adjust `temperature` (0.7 default)
5. **Add an input node**:
   - Click "‚ûï Add Node" ‚Üí "üìÅ Input/Output" ‚Üí "Context Output"
6. **Connect nodes**:
   - Drag from Context Output's `text` port (right side)
   - To OpenAI node's `text` port (left side)
7. **Add an output node**:
   - Click "‚ûï Add Node" ‚Üí "üìÅ Input/Output" ‚Üí "File Write"
   - Connect OpenAI's `text` output to File Write's `text` input
8. **Click "Run Flow"** in toolbar

### Example: Simple Summarization Flow

```
Context Output ‚Üí OpenAI Node ‚Üí File Write
 (fullcode.txt)   (gpt-4)      (summary.txt)
```

1. Add Context Output node
2. Add OpenAI node, set model to "gpt-4-turbo"
3. Add File Write node, set path to "summary.txt"
4. Connect: Context Output.text ‚Üí OpenAI.text
5. Connect: OpenAI.text ‚Üí File Write.text
6. Set OpenAI's system prompt: "Summarize this code concisely"
7. Run flow

## Technical Details

### Node Identifier Format

NodeGraphQt uses format: `<identifier>.<NODE_NAME>`

- Identifier: `aicp.flow` (our namespace)
- NODE_NAME: Class attribute like `"OpenAI Node"`
- Full: `aicp.flow.OpenAI Node`

### Node Registration

Nodes must be registered before they can be created:

```python
self.graph.register_node(OpenAINode)
```

This happens in `_register_nodes()` during `__init__`.

### Viewport Coordinate Conversion

```python
viewport_rect = self.viewer.viewport().rect()  # Widget coordinates
center_point = viewport_rect.center()           # QPoint
scene_pos = self.viewer.mapToScene(center_point)  # QPointF in scene coords
pos = (scene_pos.x(), scene_pos.y())           # Tuple for create_node()
```

## Files Modified

1. **aicodeprep_gui/pro/flow/flow_dock.py**
   - Added "‚ûï Add Node" button to `_create_toolbar()`
   - Added `_create_node_at_center()` helper method
   - Menu with 3 categories, 9 node types total

## Testing

1. **Launch app**: `python -m aicodeprep_gui.main --pro`
2. **Open Flow Studio** dock
3. **Click "‚ûï Add Node"** button in toolbar
4. **Verify menu appears** with categories
5. **Select "ü§ñ LLM Providers" ‚Üí "OpenAI (Official)"**
6. **Node should appear** at center of viewport
7. **Node should be selected** (properties panel shows on right)
8. **Try other node types** to verify all work

## Troubleshooting

### Menu doesn't appear

- Check that `add_node_btn.setMenu(add_menu)` is called
- Verify `QtWidgets.QToolButton.InstantPopup` mode is set

### Node creation fails

- Check console for error messages
- Verify node is registered in `_register_nodes()`
- Check node class has `__identifier__` and `NODE_NAME` attributes
- Ensure identifier matches: `aicp.flow` and name matches class `NODE_NAME`

### Node appears at wrong location

- Viewport center calculation may be off
- Check `self.viewer` is properly initialized
- Try zooming/panning and creating node again

### Properties panel doesn't show

- Node might not be selected
- Check `node.set_selected(True)` is called
- Verify properties panel signal connections

## Future Enhancements

Potential improvements:

1. Search box in menu for quick node finding
2. Recently used nodes section at top
3. Keyboard shortcuts for common nodes (Ctrl+1 for OpenAI, etc.)
4. Drag-and-drop node creation from menu
5. Custom node templates/presets
6. Node creation at mouse cursor position
7. Import nodes from external packages

## Alternative: Tab Key Menu

The Tab key menu (`_setup_node_creation_menu()`) is also configured but may not work in all NodeGraphQt versions. The toolbar button is the reliable fallback that works in all cases.

To use Tab menu (if available):

1. Press **Tab** key anywhere in graph
2. Type to search for node
3. Press Enter to create

If Tab menu doesn't work, use the toolbar button instead.
